<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gulf Hypoxia Dashboard — Live Onset Predictions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --bg-alt: #f8f9fb;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --border-light: #f0f1f3;
            --text: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --accent: #0c6e8c;
            --accent-light: #e8f4f8;
            --accent-dark: #064e63;
            --teal: #0d9488;
            --teal-light: #ccfbf1;
            --orange: #c2410c;
            --orange-light: #fff7ed;
            --red: #dc2626;
            --red-light: #fef2f2;
            --green: #16a34a;
            --green-light: #f0fdf4;
            --yellow: #ca8a04;
            --yellow-light: #fefce8;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.04);
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-alt);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
        }

        /* ─── Header ─── */
        .header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header h1 {
            font-size: 1.25em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .header-badge {
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--accent);
            background: var(--accent-light);
            padding: 3px 10px;
            border-radius: 20px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.85em;
            color: var(--text-muted);
        }
        .header-right a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .header-right a:hover { text-decoration: underline; }
        .update-time { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; }

        /* ─── Layout ─── */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 380px;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .main {
                grid-template-columns: 1fr;
            }
        }

        /* ─── Summary Bar ─── */
        .summary-bar {
            grid-column: 1 / -1;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .summary-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            flex: 1;
            min-width: 180px;
            box-shadow: var(--shadow-sm);
        }
        .summary-card .label {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .summary-card .value {
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .summary-card .sub {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* ─── Map ─── */
        .map-container {
            grid-column: 1 / -1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        #map { height: 380px; width: 100%; }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
        }
        .popup-station { font-weight: 700; font-size: 14px; margin-bottom: 6px; }
        .popup-do { font-family: 'JetBrains Mono', monospace; }
        .popup-risk {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-top: 4px;
        }
        .risk-low { background: var(--green-light); color: var(--green); }
        .risk-moderate { background: var(--yellow-light); color: var(--yellow); }
        .risk-high { background: var(--red-light); color: var(--red); }
        .risk-none { background: var(--bg-alt); color: var(--text-muted); }

        /* ─── Station Table ─── */
        .station-table-wrap {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .table-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            font-size: 0.9em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        thead th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        thead th:hover { color: var(--accent); }
        tbody tr {
            cursor: pointer;
            transition: background 0.1s;
        }
        tbody tr:hover { background: var(--bg-alt); }
        tbody tr.selected { background: var(--accent-light); }
        tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-light);
            white-space: nowrap;
        }
        .td-prob {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 0.9em;
        }
        .td-station { font-weight: 600; }
        .td-do { font-family: 'JetBrains Mono', monospace; }

        /* ─── Detail Panel ─── */
        .detail-panel {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .detail-panel.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-style: italic;
            min-height: 200px;
        }
        .detail-header {
            margin-bottom: 20px;
        }
        .detail-header h2 {
            font-size: 1.1em;
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        .detail-header .coords {
            font-size: 0.8em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .detail-header .status-badge {
            display: inline-block;
            margin-top: 6px;
        }

        /* Current conditions */
        .current-conditions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .condition-card {
            background: var(--bg-alt);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .condition-card .val {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3em;
            font-weight: 600;
        }
        .condition-card .unit {
            font-size: 0.7em;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        /* Forecast cards */
        .forecast-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .forecast-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
        }
        .forecast-card .lead-label {
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .forecast-card .prob-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.6em;
            font-weight: 700;
            line-height: 1;
        }
        .forecast-card .prob-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .forecast-card .prob-bar .fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        .no-model-note {
            background: var(--bg-alt);
            border-radius: 8px;
            padding: 16px;
            color: var(--text-secondary);
            font-size: 0.85em;
            line-height: 1.5;
        }

        /* Model info */
        .model-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
            font-size: 0.8em;
            color: var(--text-muted);
        }
        .model-info dt { font-weight: 600; display: inline; }
        .model-info dd { display: inline; margin-left: 4px; margin-right: 12px; }

        /* ─── Model Engine Badges ─── */
        .engine-badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 0.65em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            vertical-align: middle;
            margin-left: 6px;
        }
        .engine-xgboost {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .engine-timesfm {
            background: #fae8ff;
            color: #9333ea;
        }
        .engine-none {
            background: var(--bg-alt);
            color: var(--text-muted);
        }
        /* Benchmark comparison section */
        .benchmark-section {
            margin-top: 16px;
            padding: 14px;
            background: var(--bg-alt);
            border-radius: 8px;
        }
        .benchmark-section h4 {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .benchmark-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.82em;
        }
        .benchmark-row .lead { width: 36px; font-weight: 600; color: var(--text-secondary); }
        .benchmark-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .benchmark-bar .bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .benchmark-val {
            width: 40px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* ─── Caveat Banner ─── */
        .caveat-banner {
            grid-column: 1 / -1;
            background: var(--orange-light);
            border: 1px solid #fed7aa;
            border-radius: var(--radius);
            padding: 14px 20px;
            font-size: 0.82em;
            color: #92400e;
            line-height: 1.5;
        }
        .caveat-banner strong { font-weight: 600; }

        /* ─── Satellite Legend ─── */
        .sat-legend {
            background: rgba(255,255,255,0.92);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        .sat-legend .legend-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .sat-legend .legend-bar {
            height: 10px;
            width: 120px;
            border-radius: 2px;
            margin: 4px 0;
        }
        .sat-legend .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #555;
        }

        /* ─── Sensor values in table ─── */
        .td-temp {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }
        .td-sal {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* ─── Satellite section in detail panel ─── */
        .satellite-section {
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e8f4f8 100%);
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        .satellite-section h4 {
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--accent-dark);
            margin-bottom: 10px;
        }
        .sat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .sat-card {
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        .sat-card .val {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2em;
            font-weight: 600;
        }
        .sat-card .unit {
            font-size: 0.7em;
            color: var(--text-muted);
            display: block;
            margin-top: 2px;
        }

        /* Layer control styling */
        .layer-toggle-btn {
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            font-weight: 500;
        }
        .layer-toggle-btn:hover {
            background: #f0f0f0;
        }
        .layer-toggle-btn.active {
            background: var(--accent-light);
            color: var(--accent-dark);
            border-color: var(--accent);
        }

        /* ─── Footer ─── */
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 24px;
            font-size: 0.8em;
            color: var(--text-muted);
        }
        .footer a { color: var(--accent); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        /* ─── Loading State ─── */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ─── Error State ─── */
        .error-banner {
            grid-column: 1 / -1;
            background: var(--red-light);
            border: 1px solid #fecaca;
            border-radius: var(--radius);
            padding: 16px 20px;
            color: #991b1b;
            font-size: 0.85em;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-inner">
        <div class="header-left">
            <h1>Gulf Hypoxia Dashboard</h1>
            <span class="header-badge">Research Preview</span>
        </div>
        <div class="header-right">
            <span>Updated <span class="update-time" id="update-time">loading...</span></span>
            <a href="index.html">Read the analysis</a>
            <a href="https://github.com/AQUAVIEW-DAH/aquaview-hypoxia-demo" target="_blank">GitHub</a>
        </div>
    </div>
</div>

<div class="main" id="app">
    <div class="loading" id="loading-state">
        <div class="spinner"></div>
        Loading predictions...
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
(function() {
    'use strict';

    const DATA_URL = 'data/latest.json';
    const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

    let data = null;
    let map = null;
    let markers = {};
    let selectedStation = null;

    // ─── Risk Colors ─────────────────────────────────────────────
    function riskColor(prob) {
        if (prob == null) return '#9ca3af';
        if (prob < 0.3) return '#16a34a';
        if (prob < 0.6) return '#ca8a04';
        return '#dc2626';
    }
    function riskClass(level) {
        return 'risk-' + (level || 'none');
    }

    // ─── Time Formatting ─────────────────────────────────────────
    function timeAgo(isoStr) {
        const d = new Date(isoStr);
        const now = new Date();
        const mins = Math.floor((now - d) / 60000);
        if (mins < 1) return 'just now';
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        return Math.floor(hrs / 24) + 'd ago';
    }

    // ─── Max Risk for a Station ──────────────────────────────────
    function maxRisk(station) {
        if (!station.predictions) return { prob: null, risk: 'none', lead: null };
        let best = { prob: 0, risk: 'low', lead: null };
        for (const [lead, pred] of Object.entries(station.predictions)) {
            if (pred.prob > best.prob) {
                best = { prob: pred.prob, risk: pred.risk, lead: lead };
            }
        }
        return best;
    }

    // ─── Render ──────────────────────────────────────────────────
    function render() {
        const app = document.getElementById('app');

        // Summary bar
        const active = data.stations.filter(s => s.status === 'active').length;
        const withModels = data.summary.stations_with_models;
        const warnings = data.summary.stations_with_warnings;
        const withRealtime = data.summary.stations_with_realtime || data.stations.filter(s => s.current && (s.current.temp != null || s.current.sal != null)).length;
        const highestRisk = data.stations.reduce((a, b) => {
            const aMax = maxRisk(a).prob || 0;
            const bMax = maxRisk(b).prob || 0;
            return aMax > bMax ? a : b;
        }, data.stations[0]);

        app.innerHTML = `
            <div class="summary-bar">
                <div class="summary-card">
                    <div class="label">Monitoring Network</div>
                    <div class="value">${data.stations.length}</div>
                    <div class="sub">${withRealtime} reporting live &middot; ${withModels} with models</div>
                </div>
                <div class="summary-card">
                    <div class="label">Stations at High Risk</div>
                    <div class="value" style="color: ${warnings > 0 ? 'var(--red)' : 'var(--green)'}">${warnings}</div>
                    <div class="sub">onset probability &ge; 60%</div>
                </div>
                <div class="summary-card">
                    <div class="label">Highest Risk</div>
                    <div class="value">${highestRisk ? highestRisk.id : '—'}</div>
                    <div class="sub">${highestRisk && maxRisk(highestRisk).prob != null
                        ? (maxRisk(highestRisk).prob * 100).toFixed(0) + '% at ' + maxRisk(highestRisk).lead
                        : 'no predictions'}</div>
                </div>
                <div class="summary-card">
                    <div class="label">Last Update</div>
                    <div class="value update-time">${timeAgo(data.updated)}</div>
                    <div class="sub">every ${data.update_interval_hours}h via GitHub Actions</div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="station-table-wrap">
                <div class="table-header">All Stations</div>
                <table>
                    <thead>
                        <tr>
                            <th data-sort="id">Station</th>
                            <th data-sort="temp">Temp &deg;C</th>
                            <th data-sort="sal">Sal psu</th>
                            <th data-sort="do">DO mg/L</th>
                            <th data-sort="1d">1-day</th>
                            <th data-sort="3d">3-day</th>
                            <th data-sort="5d">5-day</th>
                            <th data-sort="7d">7-day</th>
                        </tr>
                    </thead>
                    <tbody id="station-tbody"></tbody>
                </table>
            </div>

            <div class="detail-panel empty" id="detail-panel">
                Click a station on the map or table to see details
            </div>

            <div class="caveat-banner">
                <strong>Research demo, not an operational forecast.</strong>
                Hypoxia predictions use <span class="engine-badge engine-xgboost">XGBoost</span> classifiers
                and <span class="engine-badge engine-timesfm">TimesFM</span> (Google's foundation model) for zero-shot forecasting.
                Live sensor data (temp, salinity) from NDBC. Satellite chlorophyll-a and SST from NOAA CoastWatch
                (toggle layers on the map). Updates every ${data.update_interval_hours || 6}h.
                See <a href="index.html" style="color: #92400e; text-decoration: underline;">the full analysis</a>
                for methodology.
            </div>

            <div class="footer">
                Built with <a href="https://aquaview.org">AQUAVIEW</a> &middot;
                Data from NDBC + CoastWatch &middot;
                Models: XGBoost + <a href="https://github.com/google-research/timesfm">Google TimesFM</a> &middot;
                <a href="https://github.com/AQUAVIEW-DAH/aquaview-hypoxia-demo">Source on GitHub</a>
            </div>
        `;

        renderMap();
        renderTable();

        document.getElementById('update-time').textContent = timeAgo(data.updated);
    }

    // ─── Map ─────────────────────────────────────────────────────
    let satelliteLayers = {};
    let activeSatLayer = null;

    function renderMap() {
        if (map) { map.remove(); }

        map = L.map('map', {
            scrollWheelZoom: true,
            zoomControl: true,
        }).setView([27.5, -89.0], 5);

        // Base tile layer
        const baseTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> | Satellite: <a href="https://coastwatch.noaa.gov">CoastWatch</a>',
            maxZoom: 19,
        }).addTo(map);

        // CoastWatch WMS satellite layers
        const chlaLayer = L.tileLayer.wms('https://coastwatch.noaa.gov/erddap/wms/noaacwS3BOLCIchlaDaily/request?', {
            layers: 'noaacwS3BOLCIchlaDaily:chlor_a',
            format: 'image/png',
            transparent: true,
            opacity: 0.55,
            styles: 'rainbow~Log',
            colorBarMin: 0.01,
            colorBarMax: 30,
            attribution: 'Chlorophyll: NOAA CoastWatch Sentinel-3B OLCI',
        });

        const sstLayer = L.tileLayer.wms('https://coastwatch.noaa.gov/erddap/wms/noaacwSNPPACSPOSSTL3GCDaily/request?', {
            layers: 'noaacwSNPPACSPOSSTL3GCDaily:sea_surface_temperature',
            format: 'image/png',
            transparent: true,
            opacity: 0.5,
            styles: 'rainbow~Linear',
            colorBarMin: 10,
            colorBarMax: 32,
            attribution: 'SST: NOAA CoastWatch VIIRS',
        });

        satelliteLayers = {
            'Chlorophyll-a': chlaLayer,
            'Sea Surface Temp': sstLayer,
        };

        // Add Leaflet layer control
        const overlays = {
            'Chlorophyll-a (Sentinel-3B)': chlaLayer,
            'Sea Surface Temp (VIIRS)': sstLayer,
        };
        L.control.layers(null, overlays, { position: 'topright', collapsed: false }).addTo(map);

        // Add chlorophyll layer by default
        chlaLayer.addTo(map);
        activeSatLayer = 'chla';

        // Add chlorophyll legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'sat-legend');
            div.innerHTML = `
                <div class="legend-title">Chlorophyll-a (mg/m&sup3;)</div>
                <div class="legend-bar" style="background: linear-gradient(to right, #440154, #31688e, #35b779, #fde725)"></div>
                <div class="legend-labels"><span>0.01</span><span>0.1</span><span>1</span><span>30</span></div>
            `;
            return div;
        };
        legend.addTo(map);

        // Render station markers on top of satellite layers
        const stationGroup = L.layerGroup().addTo(map);

        data.stations.forEach(station => {
            if (!station.lat || !station.lon) return;

            const risk = maxRisk(station);
            const color = riskColor(risk.prob);
            const hasLive = station.current && (station.current.temp != null || station.current.sal != null || station.current.do != null);

            // TimesFM stations get dashed stroke
            const isTfm = station.model_type === 'timesfm';
            const marker = L.circleMarker([station.lat, station.lon], {
                radius: station.has_model ? 10 : (hasLive ? 7 : 5),
                color: isTfm ? '#9333ea' : (hasLive ? '#1a1a2e' : '#9ca3af'),
                fillColor: station.has_model ? color : (hasLive ? '#0c6e8c' : '#d1d5db'),
                fillOpacity: station.has_model ? 0.8 : (hasLive ? 0.6 : 0.3),
                weight: station.has_model ? 2 : (hasLive ? 1.5 : 1),
                dashArray: isTfm ? '4 3' : null,
            }).addTo(stationGroup);

            const engineLabel = station.model_type === 'timesfm' ? ' <span class="engine-badge engine-timesfm">TFM</span>'
                : station.model_type === 'xgboost' ? ' <span class="engine-badge engine-xgboost">XGB</span>' : '';

            // Enhanced popup with temp/sal
            let popupHtml = `<div class="popup-station">${station.id}${engineLabel}</div>`;
            if (station.name) popupHtml += `<div style="font-size: 11px; color: #666; margin-bottom: 4px">${station.name}</div>`;

            const doVal = station.current && station.current.do != null ? station.current.do.toFixed(2) + ' mg/L' : '—';
            const tempVal = station.current && station.current.temp != null ? station.current.temp.toFixed(1) + '°C' : '—';
            const salVal = station.current && station.current.sal != null ? station.current.sal.toFixed(1) + ' psu' : '—';

            popupHtml += `<div class="popup-do" style="margin: 4px 0">
                <span style="color: #0c6e8c">Temp: ${tempVal}</span> &middot;
                <span>Sal: ${salVal}</span> &middot;
                <span>DO: ${doVal}</span>
            </div>`;

            if (risk.prob != null) {
                popupHtml += `<div class="popup-risk ${riskClass(risk.risk)}">${(risk.prob * 100).toFixed(0)}% onset (${risk.lead})</div>`;
            } else if (station.timesfm_benchmark) {
                const bestAuc = Math.max(...Object.values(station.timesfm_benchmark).map(v => v.auc_roc || 0));
                if (bestAuc > 0) popupHtml += `<div class="popup-risk risk-none">Benchmark AUC: ${bestAuc.toFixed(2)}</div>`;
            }

            if (station.satellite) {
                const chlaVal = station.satellite.chla != null ? station.satellite.chla.toFixed(2) + ' mg/m³' : '';
                const sstVal = station.satellite.sst != null ? station.satellite.sst.toFixed(1) + '°C' : '';
                if (chlaVal || sstVal) {
                    popupHtml += `<div style="font-size: 11px; color: #666; margin-top: 4px; border-top: 1px solid #eee; padding-top: 4px">`;
                    popupHtml += `Satellite: `;
                    if (chlaVal) popupHtml += `Chl-a ${chlaVal}`;
                    if (chlaVal && sstVal) popupHtml += ` · `;
                    if (sstVal) popupHtml += `SST ${sstVal}`;
                    popupHtml += `</div>`;
                }
            }

            marker.bindPopup(popupHtml);
            marker.on('click', () => selectStation(station.id));
            markers[station.id] = marker;
        });
    }

    // ─── Table ───────────────────────────────────────────────────
    function renderTable() {
        const tbody = document.getElementById('station-tbody');
        if (!tbody) return;

        const rows = data.stations.map(s => {
            const doVal = s.current && s.current.do != null
                ? s.current.do.toFixed(2) : '—';
            const doColor = s.current && s.current.do != null && s.current.do <= 2.0
                ? 'color: var(--red); font-weight: 700' : '';

            // Temperature cell with color gradient (blue=cool, warm=red)
            const tempVal = s.current && s.current.temp != null ? s.current.temp.toFixed(1) : '—';
            const tempColor = s.current && s.current.temp != null
                ? (s.current.temp < 15 ? 'color: #2563eb' : s.current.temp < 25 ? 'color: var(--text)' : s.current.temp < 30 ? 'color: #d97706' : 'color: #dc2626')
                : 'color: var(--text-muted)';

            // Salinity cell
            const salVal = s.current && s.current.sal != null ? s.current.sal.toFixed(1) : '—';
            const salColor = s.current && s.current.sal != null ? '' : 'color: var(--text-muted)';

            function probCell(lead) {
                if (!s.predictions || !s.predictions[lead]) return '<td class="td-prob" style="color: var(--text-muted)">—</td>';
                const p = s.predictions[lead];
                const color = riskColor(p.prob);
                return `<td class="td-prob" style="color: ${color}">${(p.prob * 100).toFixed(0)}%</td>`;
            }

            const engineBadge = s.model_type
                ? `<span class="engine-badge engine-${s.model_type}">${s.model_type === 'timesfm' ? 'TFM' : 'XGB'}</span>`
                : '';

            return `<tr data-station="${s.id}" class="${selectedStation === s.id ? 'selected' : ''}"
                        onclick="window._selectStation('${s.id}')">
                <td class="td-station">${s.id}${engineBadge}</td>
                <td class="td-temp" style="${tempColor}">${tempVal}</td>
                <td class="td-sal" style="${salColor}">${salVal}</td>
                <td class="td-do" style="${doColor}">${doVal}</td>
                ${probCell('1d')}
                ${probCell('3d')}
                ${probCell('5d')}
                ${probCell('7d')}
            </tr>`;
        }).join('');

        tbody.innerHTML = rows;

        // Sort handlers
        document.querySelectorAll('thead th[data-sort]').forEach(th => {
            th.onclick = () => sortTable(th.dataset.sort);
        });
    }

    let sortKey = '7d';
    let sortAsc = false;

    function sortTable(key) {
        if (sortKey === key) { sortAsc = !sortAsc; }
        else { sortKey = key; sortAsc = false; }

        data.stations.sort((a, b) => {
            let va, vb;
            if (key === 'id') {
                va = a.id; vb = b.id;
                return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            }
            if (key === 'do') {
                va = a.current && a.current.do != null ? a.current.do : -999;
                vb = b.current && b.current.do != null ? b.current.do : -999;
            } else if (key === 'temp') {
                va = a.current && a.current.temp != null ? a.current.temp : -999;
                vb = b.current && b.current.temp != null ? b.current.temp : -999;
            } else if (key === 'sal') {
                va = a.current && a.current.sal != null ? a.current.sal : -999;
                vb = b.current && b.current.sal != null ? b.current.sal : -999;
            } else {
                va = a.predictions && a.predictions[key] ? a.predictions[key].prob : -1;
                vb = b.predictions && b.predictions[key] ? b.predictions[key].prob : -1;
            }
            return sortAsc ? va - vb : vb - va;
        });

        renderTable();
    }

    // ─── Detail Panel ────────────────────────────────────────────
    window._selectStation = function(stationId) {
        selectStation(stationId);
    };

    function selectStation(stationId) {
        selectedStation = stationId;
        const station = data.stations.find(s => s.id === stationId);
        if (!station) return;

        // Highlight table row
        document.querySelectorAll('tbody tr').forEach(tr => {
            tr.classList.toggle('selected', tr.dataset.station === stationId);
        });

        // Highlight map marker
        Object.entries(markers).forEach(([id, m]) => {
            const s = data.stations.find(x => x.id === id);
            const risk = maxRisk(s);
            const color = riskColor(risk.prob);
            const hasLive = s && s.current && (s.current.temp != null || s.current.sal != null || s.current.do != null);
            const isTfm = s && s.model_type === 'timesfm';
            if (id === stationId) {
                m.setStyle({ weight: 4, color: '#1a1a2e', fillColor: s.has_model ? color : '#0c6e8c' });
            } else {
                m.setStyle({
                    weight: s && s.has_model ? 2 : (hasLive ? 1.5 : 1),
                    color: isTfm ? '#9333ea' : (hasLive ? '#1a1a2e' : '#9ca3af'),
                    fillColor: s.has_model ? color : (hasLive ? '#0c6e8c' : '#d1d5db'),
                });
            }
        });

        const panel = document.getElementById('detail-panel');
        panel.classList.remove('empty');

        const doVal = station.current && station.current.do != null ? station.current.do.toFixed(2) : '—';
        const tempVal = station.current && station.current.temp != null ? station.current.temp.toFixed(1) : '—';
        const salVal = station.current && station.current.sal != null ? station.current.sal.toFixed(1) : '—';
        const turbVal = station.current && station.current.turbidity != null ? station.current.turbidity.toFixed(1) : null;
        const phVal = station.current && station.current.ph != null ? station.current.ph.toFixed(2) : null;

        const engineBadgeDetail = station.model_type === 'timesfm'
            ? '<span class="engine-badge engine-timesfm" style="margin-left: 8px">TimesFM</span>'
            : station.model_type === 'xgboost'
            ? '<span class="engine-badge engine-xgboost" style="margin-left: 8px">XGBoost</span>'
            : '';

        const hasAnySensor = station.current && (station.current.temp != null || station.current.sal != null || station.current.do != null);
        const statusText = station.currently_hypoxic ? 'Currently Hypoxic'
            : station.status === 'historical_only' ? 'Historical only'
            : station.has_model && station.predictions ? maxRisk(station).risk + ' risk'
            : hasAnySensor ? 'Live monitoring'
            : station.status === 'active' ? 'Conditions only'
            : 'Offline';

        let html = `
            <div class="detail-header">
                <h2>${station.id}${engineBadgeDetail}</h2>
                <div class="coords">${station.name || ''}</div>
                ${station.lat ? `<div class="coords">${station.lat.toFixed(3)}&deg;N, ${Math.abs(station.lon).toFixed(3)}&deg;W</div>` : ''}
                <span class="popup-risk ${station.currently_hypoxic ? 'risk-high' : (hasAnySensor && !station.predictions ? 'risk-none' : riskClass(maxRisk(station).risk))} status-badge">
                    ${statusText}
                </span>
            </div>

            <div class="current-conditions">
                <div class="condition-card">
                    <div class="val" style="${station.current && station.current.do != null && station.current.do <= 2.0 ? 'color: var(--red)' : ''}">${doVal}</div>
                    <span class="unit">DO (mg/L)</span>
                </div>
                <div class="condition-card">
                    <div class="val" style="${station.current && station.current.temp != null ? (station.current.temp > 29 ? 'color: #dc2626' : station.current.temp > 25 ? 'color: #d97706' : 'color: #2563eb') : ''}">${tempVal}</div>
                    <span class="unit">Temp (&deg;C)</span>
                </div>
                <div class="condition-card">
                    <div class="val">${salVal}</div>
                    <span class="unit">Sal (psu)</span>
                </div>
            </div>
        `;

        // Extra sensor data (turbidity, pH) if available
        if (turbVal || phVal) {
            html += '<div class="current-conditions" style="margin-top: -10px; margin-bottom: 20px">';
            if (turbVal) html += `<div class="condition-card"><div class="val">${turbVal}</div><span class="unit">Turbidity (NTU)</span></div>`;
            if (phVal) html += `<div class="condition-card"><div class="val">${phVal}</div><span class="unit">pH</span></div>`;
            html += '</div>';
        }

        // Satellite data section
        if (station.satellite && (station.satellite.chla != null || station.satellite.sst != null)) {
            html += `<div class="satellite-section">
                <h4>Satellite Observations</h4>
                <div class="sat-grid">`;
            if (station.satellite.chla != null) {
                html += `<div class="sat-card">
                    <div class="val" style="color: #16a34a">${station.satellite.chla.toFixed(2)}</div>
                    <span class="unit">Chl-a (mg/m&sup3;)</span>
                </div>`;
            }
            if (station.satellite.sst != null) {
                html += `<div class="sat-card">
                    <div class="val" style="color: #0c6e8c">${station.satellite.sst.toFixed(1)}</div>
                    <span class="unit">SST (&deg;C)</span>
                </div>`;
            }
            html += `</div>`;
            if (station.satellite.date) {
                html += `<div style="font-size: 0.7em; color: var(--text-muted); margin-top: 6px; text-align: right">via CoastWatch ${station.satellite.date}</div>`;
            }
            html += `</div>`;
        }

        if (station.predictions && Object.keys(station.predictions).length > 0) {
            html += '<div class="forecast-grid">';
            for (const lead of ['1d', '3d', '5d', '7d']) {
                const pred = station.predictions[lead];
                if (!pred) continue;
                const pct = (pred.prob * 100).toFixed(0);
                const color = riskColor(pred.prob);
                html += `
                    <div class="forecast-card">
                        <div class="lead-label">${lead.replace('d', '-day')} onset</div>
                        <div class="prob-value" style="color: ${color}">${pct}%</div>
                        <div class="prob-bar"><div class="fill" style="width: ${pct}%; background: ${color}"></div></div>
                    </div>
                `;
            }
            html += '</div>';

            if (station.metrics) {
                html += '<div class="model-info"><dl>';
                for (const [lead, m] of Object.entries(station.metrics)) {
                    html += `<dt>${lead}d AUC-ROC:</dt><dd>${m.auc_roc}</dd>`;
                }
                html += '</dl></div>';
            }
        } else if (station.status === 'historical_only') {
            const modelDesc = station.model_type === 'timesfm'
                ? 'This station uses <strong>TimesFM</strong> (zero-shot foundation model) for forecasting because it has too few hypoxic events for reliable XGBoost training.'
                : station.model_type === 'xgboost'
                ? 'This station has a trained <strong>XGBoost</strong> model but no active realtime ocean data feed.'
                : 'This station has a trained model but no active realtime data feed.';
            html += `<div class="no-model-note">
                ${modelDesc}
                The station's NDBC sensor may be decommissioned or offline. Predictions will
                resume if the realtime feed becomes available again.
            </div>`;
        } else {
            html += `<div class="no-model-note">
                This station does not have a trained onset prediction model, either because it has too few
                historical hypoxic events or insufficient data for training. Current conditions are shown
                when the NDBC realtime feed is available.
            </div>`;
        }

        // Show benchmark comparison if available
        if (station.timesfm_benchmark) {
            html += '<div class="benchmark-section"><h4>Model Benchmark (AUC-ROC)</h4>';
            const leads = ['1d', '3d', '5d', '7d'];
            for (const lead of leads) {
                const tfm = station.timesfm_benchmark[lead];
                const xgb = station.xgboost_benchmark && station.xgboost_benchmark[lead];
                if (!tfm) continue;

                html += `<div class="benchmark-row"><span class="lead">${lead}</span>`;

                // TimesFM bar
                const tfmPct = (tfm.auc_roc * 100).toFixed(0);
                html += `<div class="benchmark-bar"><div class="bar-fill" style="width: ${tfmPct}%; background: #9333ea"></div></div>`;
                html += `<span class="benchmark-val" style="color: #9333ea">${tfm.auc_roc.toFixed(2)}</span>`;

                // XGBoost bar if available
                if (xgb) {
                    const xgbPct = (xgb.auc_roc * 100).toFixed(0);
                    html += `<div class="benchmark-bar"><div class="bar-fill" style="width: ${xgbPct}%; background: #1d4ed8"></div></div>`;
                    html += `<span class="benchmark-val" style="color: #1d4ed8">${xgb.auc_roc.toFixed(2)}</span>`;
                }

                html += '</div>';
            }
            html += '<div style="margin-top: 8px; font-size: 0.75em; color: var(--text-muted)">';
            html += '<span style="color: #9333ea">&#9632;</span> TimesFM (zero-shot)';
            if (station.xgboost_benchmark) {
                html += ' &nbsp; <span style="color: #1d4ed8">&#9632;</span> XGBoost (trained)';
            }
            if (station.n_hyp_days) {
                html += ` &nbsp; | &nbsp; ${station.n_hyp_days} hypoxic days in ${station.n_days || '—'} total`;
            }
            html += '</div></div>';
        }

        if (station.last_observation) {
            html += `<div class="model-info" style="margin-top: 12px">
                <dt>Last obs:</dt><dd>${station.last_observation}</dd>
                <dt>Data span:</dt><dd>${station.days_of_data || '—'} days</dd>
            </div>`;
        }

        panel.innerHTML = html;
    }

    // ─── Data Loading ────────────────────────────────────────────
    async function loadData() {
        try {
            const resp = await fetch(DATA_URL + '?t=' + Date.now());
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            data = await resp.json();

            // Sort: stations with predictions first (by risk), then stations with live data, then offline
            data.stations.sort((a, b) => {
                const pa = a.predictions && a.predictions['7d'] ? a.predictions['7d'].prob : -1;
                const pb = b.predictions && b.predictions['7d'] ? b.predictions['7d'].prob : -1;
                if (pa >= 0 || pb >= 0) return pb - pa;
                // Both lack predictions: sort by whether they have live sensor data
                const aLive = a.current && (a.current.temp != null || a.current.sal != null) ? 1 : 0;
                const bLive = b.current && (b.current.temp != null || b.current.sal != null) ? 1 : 0;
                if (aLive !== bLive) return bLive - aLive;
                return a.id.localeCompare(b.id);
            });

            render();
        } catch (err) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="error-banner">
                    Could not load prediction data. The GitHub Actions pipeline may not have run yet.
                    Check the <a href="https://github.com/AQUAVIEW-DAH/aquaview-hypoxia-demo/actions" style="color: #991b1b">Actions tab</a>
                    or try refreshing in a few minutes.
                    <br><small>${err.message}</small>
                </div>
                <div class="caveat-banner">
                    If this is a fresh deployment, you need to run the prediction pipeline at least once.
                    See the <a href="https://github.com/AQUAVIEW-DAH/aquaview-hypoxia-demo#dashboard" style="color: #92400e">README</a> for setup instructions.
                </div>
            `;
        }
    }

    // ─── Init ────────────────────────────────────────────────────
    loadData();
    setInterval(loadData, REFRESH_INTERVAL);

})();
</script>
</body>
</html>
